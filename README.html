<!-- README.md is generated from README.Rmd. Please edit that file -->
<p>It is a bit of a shock when <a href="https://cran.r-project.org">R</a> <code>dplyr</code> users switch from using a <code>tbl</code> implementation based on R in-memory <code>data.frame</code>s to one based on a remote database or service. A lot of the power and convenience of the <code>dplyr</code> notation is hard to maintain with these more restricted data service providers. Things that work locally can't always be used remotely at scale. It is emphatically not yet the case that one can practice with <code>dplyr</code> in one modality and hope to move to another back-end without significant debugging and work-arounds. <code>replyr</code> attempts to provide a few helpful work-arounds.</p>
<p><a href="https://www.flickr.com/photos/42988571@N08/18029435653" target="_blank"><img src="18029435653_4d64c656c8_z.jpg"> </a></p>
<p><code>replyr</code> supplies methods to get a grip on working with remote <code>tbl</code> sources (<code>SQL</code> databases, <code>Spark</code>) through <code>dplyr</code>. The idea is to add convenience functions to make such tasks more like working with an in-memory <code>data.frame</code>. Results still do depend on which <code>dplyr</code> service you use, but with <code>replyr</code> you have fairly uniform access to some useful functions.</p>
<p>Example: the following should work across more than one <code>dplyr</code> back-end (such as <code>RMySQL</code> or <code>RPostgreSQL</code>).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;replyr&#39;</span>)
d &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x=</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">2</span>),<span class="dt">y=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">5</span>,<span class="ot">NA</span>),<span class="dt">z=</span><span class="kw">c</span>(<span class="ot">NA</span>,<span class="st">&#39;a&#39;</span>,<span class="st">&#39;b&#39;</span>),
                <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)
<span class="kw">summary</span>(d)
 <span class="co">#         x               y            z            </span>
 <span class="co">#   Min.   :1.000   Min.   :3.0   Length:3          </span>
 <span class="co">#   1st Qu.:1.500   1st Qu.:3.5   Class :character  </span>
 <span class="co">#   Median :2.000   Median :4.0   Mode  :character  </span>
 <span class="co">#   Mean   :1.667   Mean   :4.0                     </span>
 <span class="co">#   3rd Qu.:2.000   3rd Qu.:4.5                     </span>
 <span class="co">#   Max.   :2.000   Max.   :5.0                     </span>
 <span class="co">#                   NA&#39;s   :1</span>
<span class="kw">replyr_summary</span>(d)
 <span class="co">#    column     class nrows nna nunique min max     mean        sd lexmin lexmax</span>
 <span class="co">#  1      x   numeric     3   0       2   1   2 1.666667 0.5773503   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  2      y   numeric     3   1       2   3   5 4.000000 1.4142136   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  3      z character     3   1       2  NA  NA       NA        NA      a      b</span></code></pre></div>
<p><code>replyr</code> doesn't seem to add much until you use a remote data service:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_db &lt;-<span class="st"> </span>dplyr::<span class="kw">src_sqlite</span>(<span class="st">&quot;replyr_sqliteEx.sqlite3&quot;</span>, <span class="dt">create =</span> <span class="ot">TRUE</span>)
dRemote &lt;-<span class="st"> </span>dplyr::<span class="kw">copy_to</span>(my_db,d,<span class="st">&#39;d&#39;</span>)
<span class="kw">summary</span>(dRemote)
 <span class="co">#      Length Class          Mode</span>
 <span class="co">#  src 2      src_sqlite     list</span>
 <span class="co">#  ops 3      op_base_remote list</span>
<span class="kw">replyr_summary</span>(dRemote)
 <span class="co">#    column     class nrows nna nunique min max     mean        sd lexmin lexmax</span>
 <span class="co">#  1      x   numeric     3   0       2   1   2 1.666667 0.5773503   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  2      y   numeric     3   1       2   3   5 4.000000 1.4142136   &lt;NA&gt;   &lt;NA&gt;</span>
 <span class="co">#  3      z character     3   1       2  NA  NA       NA        NA      a      b</span></code></pre></div>
<p>Data types, capabilities, and row-orders all vary a lot as we switch remote data services. But the point of <code>replyr</code> is to provide at least some convenient version of typical functions such as: <code>summary</code>, <code>nrow</code>, unique values, and filter rows by values in a set.</p>
<p>This is a <em>very</em> new package with no guarantees or claims of fitness for purpose. Some implemented operations are going to be slow and expensive (part of why they are not exposed in <code>dplyr</code> itself).</p>
<p>We will probably only ever cover:</p>
<ul class="incremental">
<li>Native <code>data.frame</code>s (and <code>tbl</code>/<code>tibble</code>)</li>
<li><code>RMySQL</code></li>
<li><code>RPostgreSQL</code></li>
<li><code>SQLite</code></li>
<li><code>sparklyr</code></li>
</ul>
<p>The type of functions <code>replyr</code> supplies is illustrated through <code>replyr::replyr_filter</code> and <code>replyr::replyr_inTest</code>. These are designed to subset data based on a columns values being in a given set. These allow selection of rows by testing membership in a set (very useful for partitioning data). Example below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(<span class="st">&#39;dplyr&#39;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">values &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">2</span>)
dRemote %&gt;%<span class="st"> </span>replyr::<span class="kw">replyr_filter</span>(<span class="st">&#39;x&#39;</span>,values)
 <span class="co">#  Source:   query [?? x 3]</span>
 <span class="co">#  Database: sqlite 3.8.6 [replyr_sqliteEx.sqlite3]</span>
 <span class="co">#  </span>
 <span class="co">#        x     y     z</span>
 <span class="co">#    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;</span>
 <span class="co">#  1     2     5     a</span>
 <span class="co">#  2     2    NA     b</span></code></pre></div>
<p>To install <code>replyr</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages(&#39;devtools&#39;)</span>
devtools::<span class="kw">install_github</span>(<span class="st">&#39;WinVector/replyr&#39;</span>)</code></pre></div>
<p>The project URL is: <a href="https://github.com/WinVector/replyr" class="uri">https://github.com/WinVector/replyr</a></p>
<p>I would like this to become a bit of a <a href="https://en.wikipedia.org/wiki/Stone_Soup">&quot;stone soup&quot;</a> project. If you have a neat function you want to add please contribute a pull request with your attribution and assignment of ownership to <a href="http://www.win-vector.com&#39;">Win-Vector LLC</a> (so Win-Vector LLC can control the code, which we are currently distributing under a GPL3 license) in the code comments.</p>
<p>There are a few (somewhat incompatible) goals for <code>replyr</code>:</p>
<ul class="incremental">
<li>Providing missing convenience functions that work well over all common <code>dplyr</code> service providers. Examples include <code>replyr_summary</code>, <code>replyr_filter</code>, and <code>replyr_nrow</code>.</li>
<li>Providing a basis for &quot;row number free&quot; data analysis. SQL back-ends don't commonly supply row number indexing (or even deterministic order of rows), so a lot of tasks you could do in memory by adjoining columns have to be done through formal key-based joins.</li>
<li>Providing emulations of functionality missing from non-favored service providers (such as windowing functions, <code>quantile</code>, <code>sample_n</code>, <code>cumsum</code>; missing from <code>SQLite</code> and <code>RMySQL</code>).</li>
<li>Working around corner case issues, and some variations in semantics.</li>
<li>Sheer bull-headedness in emulating operations that don't quite fit into the pure <code>dplyr</code> formulation.</li>
</ul>
<p>Good code should fill one important gap and work on a variety of <code>dplyr</code> back ends (you can test <code>RMySQL</code>, and <code>RPostgreSQL</code> using docker as mentioned <a href="http://www.win-vector.com/blog/2016/11/mysql-in-a-container/">here</a> and <a href="http://www.win-vector.com/blog/2016/02/databases-in-containers/">here</a>; <code>sparklyr</code> can be tried in local mode as described <a href="http://spark.rstudio.com">here</a>). I am especially interested in clever &quot;you wouldn't thing this was efficiently possible, but&quot; solutions (which give us an expanded grammar of useful operators), and replacing current hacks with more efficient general solutions. Targets of interest include <code>sample_n</code> (which isn't currently implemented for <code>tbl_sqlite</code>), <code>cumsum</code>, and <code>quantile</code>.</p>
<p>Right now we have an expensive implementation of <code>quantile</code> based on binary search.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">replyr_quantile</span>(dRemote,<span class="st">&#39;x&#39;</span>)
 <span class="co">#     0 0.25  0.5 0.75    1 </span>
 <span class="co">#     1    1    2    2    2</span></code></pre></div>
<p><code>replyr</code> services include:</p>
<ul class="incremental">
<li>Moving data into or out of the remote data store (including adding optional row numbers), <code>replyr_copy_to</code> and <code>replyr_copy_from</code>.</li>
<li>Basic summary info: <code>replyr_nrow</code>, <code>replyr_dim</code>, and <code>replyr_summary</code>.</li>
<li>Random row sampling (like <code>dplyr::sample_n</code>, but working with more service providers). Some of this functionality is provided by <code>replyr_filter</code> and <code>replyr_inTest</code>.</li>
<li>Emulating <a href="https://www.jstatsoft.org/article/view/v040i01">The Split-Apply-Combine Strategy</a>, which is the purpose <code>replyr_gapply</code>, <code>replyr_split</code>, and <code>replyr_bind_rows</code>.</li>
<li>Emulating <code>tidyr</code> gather/spread (or pivoting and anti-pivoting), which is the purpose of <code>replyr_gather</code> and <code>replyr_spread</code> (still under development).</li>
<li>Patching around differences in <code>dplyr</code> services providers (and documenting the reasons for the patches).</li>
<li>Making use of &quot;parameterized names&quot; much easier (that is: writing code does not know the name of the column it is expected to work over, but instead takes the column name from a user supplied variable).</li>
</ul>
<p>Additional desired capabilities of interest include:</p>
<ul class="incremental">
<li><code>cumsum</code> or row numbering (interestingly enough if you have row numbering you can implement cumulative sum in log-n rounds using joins to implement pointer chasing/jumping ideas, but that is unlikely to be practical, <code>lag</code> is enough to generate next pointers, which can be boosted to row-numberings).</li>
<li>Inserting random values (or even better random unique values) in a remote column. Most service providers have a pseudo-random source you can use.</li>
</ul>
<p>Note we are deliberately using prefixed names <code>replyr_</code> and not using common <code>S3</code> method names to avoid the possibility of <code>replyr</code> functions interfering with basic <code>dplyr</code> functionality.</p>
